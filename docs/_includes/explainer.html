<style>
  :root {
    /* Base Colors (Monocromático) */
    --color-bg: #ffffff;
    --color-surface: #fafbfc;
    --color-border: #e1e4e8;
    --color-text-primary: #24292e;
    --color-text-secondary: #586069;
    --color-text-tertiary: #6a737d;
    
    /* Functional Colors */
    --color-primary: #0366d6;
    --color-success: #28a745;
    --color-warning: #ffd33d;
    --color-error: #d73a49;
    
    /* Agent Colors (Subtle) */
    --color-analyzer: #79b8ff;
    --color-planner: #b392f0;
    --color-editor: #ffdf5d;
    --color-validator: #85e89d;
    
    /* Terminal Colors */
    --color-terminal-bg: #0d1117;
    --color-terminal-text: #c9d1d9;
    
    /* Legacy compatibility */
    --white: var(--color-bg);
    --text-main: var(--color-text-primary);
    --text-muted: var(--color-text-secondary);
    --text-soft: var(--color-text-tertiary);
    
    /* Typography */
    --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    --font-mono: "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
    
    /* Spacing (4px base grid) */
    --space-1: 4px;
    --space-2: 8px;
    --space-3: 12px;
    --space-4: 16px;
    --space-6: 24px;
    --space-8: 32px;
    
    /* Border Radius */
    --radius-sm: 3px;
    --radius-md: 6px;
    
    /* Shadows */
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 3px 6px rgba(0, 0, 0, 0.08);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: var(--font-sans);
    background: var(--color-surface);
    color: var(--color-text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .te-page {
    max-width: 1200px;
    margin: var(--space-8) auto;
    padding: 0 var(--space-4);
  }

  .te-shell {
    background: var(--color-bg);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-sm);
    padding: var(--space-6) var(--space-6) var(--space-8);
    overflow: hidden;
  }

  @media (min-width: 1024px) {
    .te-shell {
      padding: var(--space-6) var(--space-8);
    }
  }

  /* Header */

  .te-kicker {
    font-size: 9px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-3);
    font-weight: 600;
  }

  .te-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: var(--space-3);
    letter-spacing: -0.03em;
    color: var(--color-text-primary);
    line-height: 1.2;
  }

  .te-subtitle {
    font-size: 14px;
    color: var(--color-text-secondary);
    max-width: 720px;
    margin-bottom: var(--space-6);
    line-height: 1.6;
  }

  /* Diagram layout */

  .te-diagram-wrapper {
    position: relative;
    margin-top: var(--space-2);
  }

  .te-diagram-grid {
    position: relative;
    display: grid;
    grid-template-columns: 130px minmax(0, 520px) 130px 200px;
    column-gap: var(--space-3);
    align-items: start;
  }

  @media (max-width: 1024px) {
    .te-diagram-grid {
      grid-template-columns: 150px minmax(0, 1fr);
      grid-template-rows: auto auto auto;
      grid-template-areas:
        "embed block"
        "mlp   block"
        "prob  prob";
      row-gap: 24px;
    }

    .te-col--embed {
      grid-area: embed;
    }

    .te-col--block {
      grid-area: block;
    }

    .te-col--mlp {
      grid-area: mlp;
    }

    .te-col--prob {
      grid-area: prob;
    }
  }

  .te-top-labels {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 12px;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--color-border);
  }

  .te-top-left {
    display: flex;
    gap: var(--space-6);
    align-items: baseline;
    flex-wrap: wrap;
  }

  .te-top-right {
    display: flex;
    gap: var(--space-8);
    align-items: baseline;
    flex-wrap: wrap;
  }

  .te-label-strong {
    color: var(--color-text-primary);
    font-weight: 700;
    font-size: 11px;
  }

  /* Columns / cards */

  .te-col {
    position: relative;
  }

  .te-stage-caption {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-3);
    font-weight: 600;
  }

  .te-card {
    position: relative;
    border-radius: var(--radius-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    padding: var(--space-4);
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
    transition: box-shadow 0.2s ease, border-color 0.2s ease;
  }

  .te-card:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06), 0 2px 4px rgba(0, 0, 0, 0.03);
  }

  /* Embedding column */

  .te-embed-card {
    padding: var(--space-3) var(--space-2);
    background: var(--color-surface);
  }

  .te-embed-tube {
    display: none;
  }

  .te-token-row {
    display: grid;
    grid-template-columns: 1fr 42px;
    align-items: center;
    padding: var(--space-1) var(--space-2);
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: var(--radius-sm);
    margin: 1px 0;
  }

  .te-token-row:hover {
    background: rgba(3, 102, 214, 0.04);
    transform: translateX(2px);
  }

  .te-token-label {
    text-align: right;
    padding-right: var(--space-2);
    font-size: 13px;
    font-family: var(--font-mono);
    white-space: nowrap;
    color: var(--color-text-secondary);
    font-weight: 500;
  }

  .te-token-vec-wrap {
    display: flex;
    align-items: center;
  }

  .te-token-vec {
    width: 34px;
    height: 14px;
    border-radius: 3px;
    background: var(--color-border);
    transition: background 0.2s ease, transform 0.2s ease;
    position: relative;
  }

  .te-token-vec::after {
    content: '';
    position: absolute;
    inset: 2px;
    background: var(--color-surface);
    border-radius: 2px;
  }

  .te-token-row.is-active .te-token-label {
    color: var(--color-primary);
    font-weight: 600;
  }

  .te-token-row.is-active .te-token-vec {
    background: var(--color-primary);
    transform: scaleX(1.2);
    box-shadow: 0 0 0 2px rgba(3, 102, 214, 0.15);
  }

  .te-token-row.is-active .te-token-vec::after {
    background: linear-gradient(90deg, rgba(3, 102, 214, 0.2) 0%, rgba(3, 102, 214, 0.05) 100%);
  }

  /* Block (Q/K/V + Attention) */

  .te-block-header {
    text-align: center;
    font-size: 13px;
    color: var(--text-soft);
    margin-bottom: 6px;
  }

  .te-block-header strong {
    color: var(--text-main);
  }

  .te-block-card {
    padding: var(--space-4);
  }

  .te-block-tube {
    display: none;
  }

  .te-block-inner {
    position: relative;
    display: grid;
    grid-template-columns: 1.4fr 1fr;
    column-gap: var(--space-6);
    z-index: 1;
  }

  .te-kqv-block {
    font-size: 11px;
  }

  .te-kqv-label {
    font-weight: 700;
    margin-bottom: var(--space-1);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .te-kqv-label--k {
    color: var(--color-text-primary);
    opacity: 0.9;
  }

  .te-kqv-label--q {
    color: var(--color-text-primary);
    opacity: 0.9;
  }

  .te-kqv-label--v {
    color: var(--color-text-primary);
    opacity: 0.9;
  }

  .te-kqv-lines div {
    color: var(--color-text-secondary);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 2px 0;
    font-size: 11px;
    line-height: 1.5;
  }

  .te-attention-block {
    text-align: center;
    font-size: 10px;
    color: var(--color-text-tertiary);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
  }

  .te-attention-dots {
    display: grid;
    grid-template-columns: repeat(4, 18px);
    grid-auto-rows: 18px;
    gap: var(--space-2);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
  }

  .te-attn-dot {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .te-attn-dot.is-active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    transform: scale(1.2);
    box-shadow: 0 0 0 2px rgba(3, 102, 214, 0.2), 0 2px 4px rgba(3, 102, 214, 0.15);
  }

  .te-attn-head-caption {
    color: var(--color-text-tertiary);
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
  }

  /* MLP */

  .te-mlp-card {
    padding: var(--space-3) var(--space-2);
    background: var(--color-surface);
  }

  .te-mlp-tube {
    display: none;
  }

  .te-mlp-rows {
    display: grid;
    grid-template-columns: 1fr 32px;
    grid-auto-rows: 22px;
    row-gap: var(--space-1);
  }

  .te-mlp-token {
    font-size: 13px;
    color: var(--color-text-secondary);
    font-family: var(--font-mono);
    font-weight: 500;
    display: flex;
    align-items: center;
    transition: color 0.2s ease, font-weight 0.2s ease;
  }

  .te-mlp-token.is-active {
    color: var(--color-primary);
    font-weight: 600;
  }

  .te-mlp-bar {
    width: 30px;
    height: 6px;
    border-radius: var(--radius-sm);
    background: var(--color-border);
    position: relative;
  }

  .te-mlp-bar::after {
    content: '';
    position: absolute;
    inset: 1px;
    background: var(--color-surface);
    border-radius: 2px;
  }

  /* Probabilities */

  .te-prob-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-2);
    font-weight: 600;
  }

  .te-prob-card {
    padding: var(--space-3);
  }

  .te-prob-row {
    display: grid;
    grid-template-columns: 1fr 70px;
    column-gap: var(--space-2);
    align-items: center;
    font-size: 11px;
    margin-bottom: var(--space-1);
    padding: var(--space-1);
    border-radius: var(--radius-sm);
    cursor: default;
    transition: all 0.2s ease;
  }

  .te-prob-label {
    color: var(--color-text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500;
  }

  .te-prob-bar-wrap {
    display: flex;
    align-items: center;
    gap: 4px;
    font-variant-numeric: tabular-nums;
  }

  .te-prob-bar {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    overflow: hidden;
  }

  .te-prob-bar-inner {
    height: 100%;
    width: 0%;
    background: var(--color-text-tertiary);
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.2s ease;
    border-radius: 2px;
  }

  .te-prob-percent {
    color: var(--color-text-tertiary);
    transition: color 0.2s ease;
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
  }

  .te-prob-row--main .te-prob-label {
    color: var(--color-primary);
    font-weight: 600;
  }

  .te-prob-row--main .te-prob-bar-inner {
    width: 60%;
    background: var(--color-primary);
  }

  .te-prob-row--main .te-prob-percent {
    color: var(--color-primary);
  }

  .te-prob-row--mid .te-prob-bar-inner {
    width: 18%;
  }

  .te-prob-row--low .te-prob-bar-inner {
    width: 8%;
  }

  .te-prob-row--zero .te-prob-bar-inner {
    width: 0%;
  }

  .te-prob-row.is-active {
    background: rgba(3, 102, 214, 0.05);
    transform: translateX(-2px);
  }

  .te-prob-row.is-active .te-prob-label {
    color: var(--color-primary);
    font-weight: 600;
  }

  .te-prob-row.is-active .te-prob-bar-inner {
    background: var(--color-primary);
  }

  .te-prob-row.is-active .te-prob-percent {
    color: var(--color-primary);
  }

  /* Connection curves (SVG) */

  .te-curve-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: visible;
  }

  .te-curve-path {
    fill: none;
    stroke: var(--color-border);
    stroke-width: 1.5;
    stroke-linecap: round;
    transition:
      stroke 0.25s cubic-bezier(0.4, 0, 0.2, 1),
      stroke-width 0.25s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0.4;
  }

  .te-curve-path.is-active {
    stroke: var(--color-primary);
    stroke-width: 2.5;
    opacity: 1;
  }

  .te-curve-path.is-muted {
    opacity: 0.15;
  }

  .te-diagram-wrapper.is-hovering-token .te-curve-path {
    opacity: 0.2;
  }

  /* === OBSERVATORY-STYLE LAYOUT === */
  :root {
    --obs-bg: #ffffff;
    --obs-panel-bg: #f8f9fa;
    --obs-border: #e2e8f0;
    --obs-text: #1e293b;
    --obs-text-muted: #64748b;
    --obs-success: #10b981;
    --obs-terminal-bg: #1e1e1e;
  }

  .explainer-container {
    max-width: 1200px;
    /* Increased to 1200px */
    margin: 32px auto;
    padding: 0 16px;
    font-family: var(--font-sans);
  }

  /* Main Interface Window */
  .demo-interface {
    display: grid;
    grid-template-columns: 300px 1fr;
    /* Reduced terminal width */
    height: 580px;
    /* Reduced from 680px */
    background: var(--white);
    border: 1px solid var(--obs-border);
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    overflow: hidden;
    margin-bottom: 0;
    /* Attached to stats below if we want, or small gap */
  }

  /* Left Panel: Terminal */
  .terminal-panel {
    background: var(--color-terminal-bg);
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--color-border);
  }

  .terminal-header {
    padding: var(--space-3) var(--space-4);
    background: var(--color-terminal-bg);
    display: flex;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .terminal-controls {
    display: none;
  }

  .control {
    display: none;
  }

  .terminal-title {
    flex: 1;
    text-align: left;
    color: var(--color-text-tertiary);
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.02em;
  }

  .terminal-body {
    flex: 1;
    padding: var(--space-4);
    font-family: var(--font-mono);
    font-size: 12px;
    line-height: 1.4;
    color: var(--color-terminal-text);
    overflow-y: auto;
    max-height: 100%;
    scroll-behavior: smooth;
  }

  /* Right Panel: Pages */
  .pages-panel {
    background: var(--obs-panel-bg);
    position: relative;
    overflow: hidden;
    /* Contain the pages */
    display: flex;
    flex-direction: column;
  }

  .page {
    display: none;
    height: 100%;
    overflow-y: auto;
    padding: var(--space-4);
    animation: fadeIn 0.4s ease;
  }


  .page.active {
    display: block;
  }

  /* Remove the old shell styling since we are inside the panel now */
  .te-shell {
    background: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
  }

  /* Make Page 1 elements more uniform */
  .te-diagram-grid {
    align-items: stretch;
    /* Stretch cards to match height */
  }

  .te-col {
    display: flex;
    flex-direction: column;
  }

  .te-card {
    flex: 1;
    /* Make cards fill the column height */
    display: flex;
    flex-direction: column;
    justify-content: center;
    /* Center content vertically if card is taller */
  }

  /* Exception for embedding/MLP which might look weird if stretched too much, 
       but let's try to keep them consistent */

  /* Stats Bar */
  .viz-stats {
    margin-top: -1px;
    padding: var(--space-3) var(--space-6);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-top: none;
    border-radius: 0 0 var(--radius-md) var(--radius-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: none;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .stat-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--color-text-tertiary);
    font-weight: 600;
  }

  .stat-value {
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 500;
    color: var(--color-text-primary);
  }

  .status-badge {
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 10px;
    font-weight: 600;
    background: var(--color-border);
    color: var(--color-text-secondary);
    letter-spacing: 0.02em;
  }

  .status-badge.running {
    background: #dbeafe;
    color: #1e40af;
  }

  .status-badge.success {
    background: #d1fae5;
    color: var(--color-success);
  }

  /* Navigation Dots - moved inside pages panel or overlay */
  .page-nav {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    display: flex;
    gap: 8px;
    justify-content: center;
    z-index: 10;
  }

  /* Highlight classes for other pages */
  .te-prob-row.is-highlighted {
    background: rgba(3, 102, 214, 0.05);
    transform: translateX(-2px);
  }

  .te-prob-row.is-highlighted .te-prob-label {
    color: var(--color-primary);
    font-weight: 600;
  }

  .te-card.is-highlighted {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(3, 102, 214, 0.1);
    transform: scale(1.01);
  }

  /* New Visual Elements */
  .agent-detail {
    margin-top: 12px;
    background: #f1f5f9;
    border-radius: 8px;
    padding: 8px;
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: opacity 0.4s ease, max-height 0.4s ease, transform 0.3s ease;
    margin-top: 8px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 0;
    transform: translateY(-10px);
  }

  .agent-detail.visible {
    opacity: 1;
    max-height: 500px;
    padding: 8px;
    transform: translateY(0);
  }

  .detail-item {
    opacity: 0;
    transform: translateX(-10px);
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 4px 0;
    font-size: 11px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .detail-item.visible {
    opacity: 1;
    transform: translateX(0);
  }

  .detail-item:hover {
    background: #f1f5f9;
    margin: 0 -4px;
    padding: 4px 4px;
    border-radius: 4px;
  }

  .detail-icon {
    width: 12px;
    height: 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: #e2e8f0;
    color: #64748b;
    font-size: 8px;
  }

  .detail-item.success .detail-icon {
    background: #dcfce7;
    color: #166534;
  }

  .code-diff {
    background: #1e293b;
    color: #e2e8f0;
    padding: 8px;
    border-radius: 6px;
    margin-top: 6px;
    font-size: 10px;
    line-height: 1.4;
    overflow: hidden;
  }

  .diff-line {
    display: block;
    white-space: pre;
  }

  .diff-add {
    color: #4ade80;
  }

  .diff-del {
    color: #f87171;
  }

  .diff-ctx {
    color: #94a3b8;
  }

  .routing-extra {
    margin-top: 16px;
    padding: 12px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .routing-extra.visible {
    display: block;
    opacity: 1;
  }

  .model-card {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .model-icon {
    width: 32px;
    height: 32px;
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .complexity-meter {
    height: 4px;
    background: #e2e8f0;
    border-radius: 2px;
    overflow: hidden;
    margin-top: 4px;
  }

  .complexity-fill {
    height: 100%;
    width: 0%;
    background: var(--prob-purple);
    transition: width 1s ease;
  }

  /* Ensemble Visualization */
  .ensemble-viz {
    margin-top: 16px;
    padding: 12px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .ensemble-viz.visible {
    display: block;
    opacity: 1;
  }

  .ensemble-models {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }

  .ensemble-model {
    flex: 1;
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 6px;
    text-align: center;
    font-size: 10px;
    position: relative;
    overflow: hidden;
  }

  .ensemble-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 0%;
    opacity: 0.2;
    transition: height 0.5s ease;
  }

  .ensemble-model.xgboost .ensemble-bar {
    background: #f59e0b;
  }

  /* Amber */
  .ensemble-model.kan .ensemble-bar {
    background: #3b82f6;
  }

  /* Blue */

  .ensemble-mixing {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .mixing-line {
    height: 1px;
    background: #cbd5e1;
    flex: 1;
  }
</style>
<div class="explainer-container">
  <!-- Main Interface Window -->
  <div class="demo-interface">
    <!-- Left Panel: Terminal -->
    <div class="terminal-panel">
      <div class="terminal-header">
        <div class="terminal-controls">
          <span class="control close"></span>
          <span class="control minimize"></span>
          <span class="control maximize"></span>
        </div>
        <div class="terminal-title">$ chu do "add user authentication"</div>
      </div>
      <div class="terminal-body" id="terminal">
        <!-- Terminal output -->
      </div>
    </div>

    <!-- Right Panel: Pages -->
    <div class="pages-panel">
      <!-- Page 1: Transformer Input Analysis -->
      <div class="page active" id="page-1">
        <main class="te-page" style="margin: 0; padding: 0;">
          <section class="te-shell">
            <header>
              <div class="te-kicker">AI AGENT EXECUTION FLOW VISUALLY EXPLAINED</div>
              <h1 class="te-title">Input Analysis · Transformers</h1>
              <p class="te-subtitle">
                Watch how the transformer processes your command through self-attention to generate intent
                predictions.
              </p>
            </header>

            <div class="te-diagram-wrapper" id="diagram-root">
              <!-- SVG layer for curves -->
              <svg class="te-curve-layer" id="curve-layer"></svg>

              <!-- Top labels -->
              <div class="te-top-labels">
                <div class="te-top-left">
                  <span class="te-label-strong">Embedding</span>
                  <div>
                    <span class="te-label-strong">Transformer Block</span>
                    <span> · <strong>Multi-head Self Attention</strong></span>
                  </div>
                </div>
                <div class="te-top-right">
                  <span class="te-label-strong">MLP</span>
                  <span class="te-label-strong">Intent Probabilities</span>
                </div>
              </div>

              <!-- Main grid -->
              <div class="te-diagram-grid">
                <!-- Embedding / Tokens -->
                <section class="te-col te-col--embed">
                  <div class="te-stage-caption">Embedding</div>
                  <div class="te-card te-embed-card">
                    <div class="te-token-row" data-token-index="0">
                      <div class="te-token-label">chu</div>
                      <div class="te-token-vec-wrap">
                        <div class="te-token-vec"></div>
                      </div>
                    </div>
                    <div class="te-token-row" data-token-index="1">
                      <div class="te-token-label">do</div>
                      <div class="te-token-vec-wrap">
                        <div class="te-token-vec"></div>
                      </div>
                    </div>
                    <div class="te-token-row" data-token-index="2">
                      <div class="te-token-label">"add</div>
                      <div class="te-token-vec-wrap">
                        <div class="te-token-vec"></div>
                      </div>
                    </div>
                    <div class="te-token-row" data-token-index="3">
                      <div class="te-token-label">user</div>
                      <div class="te-token-vec-wrap">
                        <div class="te-token-vec"></div>
                      </div>
                    </div>
                    <div class="te-token-row" data-token-index="4">
                      <div class="te-token-label">auth"</div>
                      <div class="te-token-vec-wrap">
                        <div class="te-token-vec"></div>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Transformer Block (Q/K/V + Attention) -->
                <section class="te-col te-col--block">
                  <div class="te-stage-caption">Transformer Block</div>
                  <div class="te-card te-block-card">
                    <div class="te-block-inner">
                      <div class="te-kqv-block">
                        <div class="te-kqv-label te-kqv-label--k">Key (K)</div>
                        <div class="te-kqv-lines">
                          <div>command structure</div>
                          <div>operation type</div>
                          <div>target entity</div>
                        </div>

                        <div style="height:6px"></div>

                        <div class="te-kqv-label te-kqv-label--q">Query (Q)</div>
                        <div class="te-kqv-lines">
                          <div>add user auth</div>
                          <div>security feature</div>
                        </div>

                        <div style="height:6px"></div>

                        <div class="te-kqv-label te-kqv-label--v">Value (V)</div>
                        <div class="te-kqv-lines">
                          <div>authentication context</div>
                          <div>user management</div>
                        </div>
                      </div>

                      <div class="te-attention-block">
                        <div class="te-attention-dots">
                          <!-- 4x4 grid -->
                          <div class="te-attn-dot" data-attn-row="0"></div>
                          <div class="te-attn-dot" data-attn-row="0"></div>
                          <div class="te-attn-dot" data-attn-row="0"></div>
                          <div class="te-attn-dot" data-attn-row="0"></div>

                          <div class="te-attn-dot" data-attn-row="1"></div>
                          <div class="te-attn-dot" data-attn-row="1"></div>
                          <div class="te-attn-dot" data-attn-row="1"></div>
                          <div class="te-attn-dot" data-attn-row="1"></div>

                          <div class="te-attn-dot" data-attn-row="2"></div>
                          <div class="te-attn-dot" data-attn-row="2"></div>
                          <div class="te-attn-dot" data-attn-row="2"></div>
                          <div class="te-attn-dot" data-attn-row="2"></div>

                          <div class="te-attn-dot" data-attn-row="3"></div>
                          <div class="te-attn-dot" data-attn-row="3"></div>
                          <div class="te-attn-dot" data-attn-row="3"></div>
                          <div class="te-attn-dot" data-attn-row="3"></div>
                        </div>
                        <div class="te-attn-head-caption">Attention</div>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- MLP -->
                <section class="te-col te-col--mlp">
                  <div class="te-stage-caption">MLP</div>
                  <div class="te-card te-mlp-card">
                    <div class="te-mlp-rows">
                      <div class="te-mlp-token" data-mlp-index="0">chu</div>
                      <div class="te-mlp-bar" data-mlp-index="0"></div>
                      <div class="te-mlp-token" data-mlp-index="1">do</div>
                      <div class="te-mlp-bar" data-mlp-index="1"></div>
                      <div class="te-mlp-token" data-mlp-index="2">"add</div>
                      <div class="te-mlp-bar" data-mlp-index="2"></div>
                      <div class="te-mlp-token" data-mlp-index="3">user</div>
                      <div class="te-mlp-bar" data-mlp-index="3"></div>
                      <div class="te-mlp-token" data-mlp-index="4">auth"</div>
                      <div class="te-mlp-bar" data-mlp-index="4"></div>
                    </div>
                  </div>
                </section>

                <!-- Probabilities -->
                <section class="te-col te-col--prob">
                  <div class="te-prob-title">Intent Classification</div>
                  <div class="te-card te-prob-card">
                    <div class="te-prob-row te-prob-row--main">
                      <div class="te-prob-label">authentication_add</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent">60%</div>
                      </div>
                    </div>
                    <div class="te-prob-row te-prob-row--mid">
                      <div class="te-prob-label">user_create</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent">18%</div>
                      </div>
                    </div>
                    <div class="te-prob-row te-prob-row--low">
                      <div class="te-prob-label">security_config</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent">8%</div>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
            </div>
          </section>
        </main>

        <script>
          (function () {
            const root = document.getElementById('diagram-root');
            const svg = document.getElementById('curve-layer');
            if (!root || !svg) return;

            const tokenRows = Array.from(root.querySelectorAll('.te-token-row'));
            const attnDots = Array.from(root.querySelectorAll('.te-attn-dot'));
            const mlpTokens = Array.from(root.querySelectorAll('.te-mlp-token'));
            const probRows = Array.from(root.querySelectorAll('.te-prob-row'));
            const connections = [];
            const mlpConnections = [];
            const probConnections = [];

            function createPathElement(svgLayer) {
              const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
              path.classList.add('te-curve-path');
              svgLayer.appendChild(path);
              return path;
            }

            function rebuildConnections() {
              svg.innerHTML = '';
              const rootRect = root.getBoundingClientRect();
              svg.setAttribute('width', rootRect.width);
              svg.setAttribute('height', rootRect.height);
              svg.setAttribute('viewBox', `0 0 ${rootRect.width} ${rootRect.height}`);

              connections.length = 0;
              mlpConnections.length = 0;
              probConnections.length = 0;

              // Embedding → Attention connections
              tokenRows.forEach((tokenEl, idx) => {
                const dotsForRow = attnDots.filter(d => d.getAttribute('data-attn-row') === String(idx));
                if (!dotsForRow.length) return;

                const tokenRect = tokenEl.getBoundingClientRect();
                const midTokenX = tokenRect.right - rootRect.left;
                const midTokenY = tokenRect.top + tokenRect.height / 2 - rootRect.top;

                const targetDot = dotsForRow[Math.floor(dotsForRow.length / 2)];
                const dotRect = targetDot.getBoundingClientRect();
                const midDotX = dotRect.left + dotRect.width / 2 - rootRect.left;
                const midDotY = dotRect.top + dotRect.height / 2 - rootRect.top;

                const dx = Math.abs(midDotX - midTokenX);
                const cpOffset = Math.max(80, dx * 0.6);

                const c1x = midTokenX + cpOffset;
                const c1y = midTokenY;
                const c2x = midDotX - cpOffset * 0.4;
                const c2y = midDotY;

                const d = ['M', midTokenX, midTokenY, 'C', c1x, c1y, c2x, c2y, midDotX, midDotY].join(' ');

                const path = createPathElement(svg);
                path.setAttribute('d', d);
                path.dataset.tokenIndex = String(idx);

                connections.push({ tokenIndex: idx, path });
              });

              // Attention → MLP connections
              const attnBlock = root.querySelector('.te-attention-block');
              if (attnBlock && mlpTokens.length) {
                const attnRect = attnBlock.getBoundingClientRect();
                const attnCenterX = attnRect.right - rootRect.left;
                const attnCenterY = attnRect.top + attnRect.height / 2 - rootRect.top;

                mlpTokens.forEach((mlpEl, idx) => {
                  const mlpRect = mlpEl.getBoundingClientRect();
                  const mlpLeftX = mlpRect.left - rootRect.left;
                  const mlpCenterY = mlpRect.top + mlpRect.height / 2 - rootRect.top;

                  const dx = Math.abs(mlpLeftX - attnCenterX);
                  const cpOffset = Math.max(40, dx * 0.5);

                  const c1x = attnCenterX + cpOffset;
                  const c1y = attnCenterY;
                  const c2x = mlpLeftX - cpOffset * 0.4;
                  const c2y = mlpCenterY;

                  const d = ['M', attnCenterX, attnCenterY, 'C', c1x, c1y, c2x, c2y, mlpLeftX, mlpCenterY].join(' ');

                  const path = createPathElement(svg);
                  path.setAttribute('d', d);
                  path.dataset.mlpIndex = String(idx);

                  mlpConnections.push({ mlpIndex: idx, path });
                });
              }

              // MLP → Probabilities connections
              const mlpCard = root.querySelector('.te-mlp-card');
              if (mlpCard && probRows.length) {
                const mlpRect = mlpCard.getBoundingClientRect();
                const mlpRightX = mlpRect.right - rootRect.left;
                const mlpCenterY = mlpRect.top + mlpRect.height / 2 - rootRect.top;

                probRows.forEach((probEl, idx) => {
                  const probRect = probEl.getBoundingClientRect();
                  const probLeftX = probRect.left - rootRect.left;
                  const probCenterY = probRect.top + probRect.height / 2 - rootRect.top;

                  const dx = Math.abs(probLeftX - mlpRightX);
                  const cpOffset = Math.max(30, dx * 0.5);

                  const c1x = mlpRightX + cpOffset;
                  const c1y = mlpCenterY;
                  const c2x = probLeftX - cpOffset * 0.4;
                  const c2y = probCenterY;

                  const d = ['M', mlpRightX, mlpCenterY, 'C', c1x, c1y, c2x, c2y, probLeftX, probCenterY].join(' ');

                  const path = createPathElement(svg);
                  path.setAttribute('d', d);
                  path.dataset.probIndex = String(idx);

                  probConnections.push({ probIndex: idx, path });
                });
              }
            }

            function clearHighlights() {
              root.classList.remove('is-hovering-token');
              tokenRows.forEach(row => row.classList.remove('is-active'));
              attnDots.forEach(dot => dot.classList.remove('is-active'));
              mlpTokens.forEach(t => t.classList.remove('is-active'));
              connections.forEach(conn => conn.path.classList.remove('is-active'));
              mlpConnections.forEach(conn => conn.path.classList.remove('is-active'));
              probConnections.forEach(conn => conn.path.classList.remove('is-active'));
              probRows.forEach(row => row.classList.remove('is-active'));
            }

            function highlightToken(index) {
              root.classList.add('is-hovering-token');

              tokenRows.forEach((row, i) => {
                row.classList.toggle('is-active', i === index);
              });

              attnDots.forEach((dot) => {
                const row = dot.getAttribute('data-attn-row');
                dot.classList.toggle('is-active', String(index) === row);
              });

              connections.forEach(conn => {
                conn.path.classList.toggle('is-active', conn.tokenIndex === index);
              });

              // Highlight MLP token
              mlpTokens.forEach((t, i) => {
                t.classList.toggle('is-active', i === index);
              });

              // Highlight MLP connections
              mlpConnections.forEach(conn => {
                conn.path.classList.toggle('is-active', conn.mlpIndex === index);
              });

              // Highlight the corresponding probability row
              // For simplicity: tokens 0-1 map to prob 0, 2-3 to 1, 4 to 2
              const probIndex = index <= 1 ? 0 : (index <= 3 ? 1 : 2);
              probRows.forEach((row, i) => {
                row.classList.toggle('is-active', i === probIndex);
              });

              // Highlight prob connections
              probConnections.forEach(conn => {
                conn.path.classList.toggle('is-active', conn.probIndex === probIndex);
              });
            }

            tokenRows.forEach((row, i) => {
              row.addEventListener('mouseenter', () => highlightToken(i));
              row.addEventListener('mouseleave', () => clearHighlights());
            });

            // Expose for Director
            window.clearHighlights = clearHighlights;
            window.highlightToken = highlightToken;

            // Initial build
            window.addEventListener('load', rebuildConnections);
            setTimeout(rebuildConnections, 100);
          })();
        </script>
      </div>

      <div class="page" id="page-2">
        <main class="te-page" style="margin:0;padding:0">
          <section class="te-shell">
            <header>
              <div class="te-kicker">AI AGENT EXECUTION FLOW VISUALLY EXPLAINED</div>
              <h1 class="te-title">Intelligence Routing</h1>
              <p class="te-subtitle">
                Based on the intent classification, the system routes to the appropriate execution mode.
              </p>
            </header>

            <div class="te-diagram-wrapper" id="routing-root">
              <!-- SVG layer for curves -->
              <svg class="te-curve-layer" id="routing-curves"></svg>

              <div class="te-diagram-grid" style="grid-template-columns: 200px 1fr 200px;">
                <!-- Features Column -->
                <div class="te-col">
                  <div class="te-stage-caption">Request Features</div>
                  <div class="te-card te-prob-card">
                    <div class="te-prob-row" id="feat-0">
                      <div class="te-prob-label">Intent: Modify Code</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner" style="width: 90%"></div>
                        </div>
                      </div>
                    </div>
                    <div class="te-prob-row" id="feat-1">
                      <div class="te-prob-label">Complexity: High</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner" style="width: 75%"></div>
                        </div>
                      </div>
                    </div>
                    <div class="te-prob-row" id="feat-2">
                      <div class="te-prob-label">Context: 14 Files</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner" style="width: 40%"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- New Routing Extra: Complexity Meter -->
                  <div class="routing-extra" id="routing-extra">
                    <div class="te-stage-caption">Decision Factors</div>
                    <div class="model-card">
                      <div class="model-icon">λ</div>
                      <div>
                        <div style="font-weight: 600; font-size: 12px;">Model Recommender</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Profile: Balanced</div>
                      </div>
                    </div>
                    <div style="font-size: 11px; margin-bottom: 2px;">Estimated Complexity</div>
                    <div class="complexity-meter">
                      <div class="complexity-fill" id="complexity-fill"></div>
                    </div>

                  </div>
                </div>

                <!-- Agents Column -->
                <div class="te-col">
                  <div class="te-stage-caption" style="font-size: 11px; margin-bottom: 5px;">Autonomous Agents</div>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="te-card" style="padding: 8px; border-left: 3px solid #06b6d4;">
                      <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                        <div style="font-weight: 600; font-size: 11px;">Analyzer</div>
                        <div style="font-size: 9px; color: #06b6d4; font-weight: 600;">Active</div>
                      </div>
                      <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 4px;">Scans codebase & builds
                        dependency graph</div>
                      <div class="agent-detail" id="analyzer-details">
                        <div class="detail-item" style="font-size: 9px;"><span class="detail-icon">→</span>
                          src/auth/index.ts</div>
                        <div class="detail-item" style="font-size: 9px;"><span class="detail-icon">→</span>
                          src/middleware/jwt.ts</div>
                      </div>
                    </div>

                    <div class="te-card" style="padding: 8px; border-left: 3px solid #8b5cf6;">
                      <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                        <div style="font-weight: 600; font-size: 11px;">Planner</div>
                        <div style="font-size: 9px; color: #8b5cf6; font-weight: 600;">Planning</div>
                      </div>
                      <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 4px;">Creates structured
                        implementation plan</div>
                      <div class="agent-detail" id="planner-details">
                        <div class="detail-item" style="font-size: 9px;"><span class="detail-icon">1</span> Define JWT
                          schema</div>
                        <div class="detail-item" style="font-size: 9px;"><span class="detail-icon">2</span> Update
                          middleware</div>
                      </div>
                    </div>

                    <div class="te-card" style="padding: 8px; border-left: 3px solid #f59e0b;">
                      <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                        <div style="font-weight: 600; font-size: 11px;">Editor</div>
                        <div style="font-size: 9px; color: #f59e0b; font-weight: 600;">Editing</div>
                      </div>
                      <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 4px;">Applies code changes to
                        files</div>
                      <div class="agent-detail" id="editor-details">
                        <div class="code-diff" style="font-size: 9px;">
                          <span class="diff-line diff-add">+ export const authMiddleware...</span>
                        </div>
                      </div>
                    </div>

                    <div class="te-card" style="padding: 8px; border-left: 3px solid #10b981;">
                      <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                        <div style="font-weight: 600; font-size: 11px;">Validator</div>
                        <div style="font-size: 9px; color: #10b981; font-weight: 600;">Testing</div>
                      </div>
                      <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 4px;">Runs tests & linters
                      </div>
                      <div class="agent-detail" id="validator-details">
                        <div class="detail-item success" style="font-size: 9px;"><span class="detail-icon">✓</span> All
                          tests passed</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Routes -->
                <section class="te-col">
                  <div class="te-stage-caption" style="font-size: 11px; margin-bottom: 6px;">Execution Mode</div>
                  <div class="te-card te-prob-card" style="padding: 6px 8px;">
                    <div class="te-prob-row te-prob-row--main" data-route="0" style="margin-bottom: 4px;">
                      <div class="te-prob-label" style="font-size: 11px;">Orchestrated</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar" style="height: 6px;">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent" style="font-size: 10px;">92%</div>
                      </div>
                    </div>
                    <div class="te-prob-row te-prob-row--mid" data-route="1" style="margin-bottom: 4px;">
                      <div class="te-prob-label" style="font-size: 11px;">Single Agent</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar" style="height: 6px;">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent" style="font-size: 10px;">6%</div>
                      </div>
                    </div>
                    <div class="te-prob-row te-prob-row--low" data-route="2">
                      <div class="te-prob-label" style="font-size: 11px;">Direct LLM</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar" style="height: 6px;">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent" style="font-size: 10px;">2%</div>
                      </div>
                    </div>
                  </div>

                  <!-- Ensemble below Execution Mode -->
                  <div class="te-card te-block-card" style="padding:8px; margin-top:8px;">
                    <div style="font-size:10px; font-weight:600; margin-bottom:4px; text-align:center;">Ensemble
                      Optimization</div>

                    <div class="ensemble-viz visible" id="ensemble-viz"
                      style="margin-top:2px; background:transparent; border:none; padding:0;">
                      <div class="ensemble-models" style="gap: 6px;">
                        <div class="ensemble-model xgboost" style="height: 60px;">
                          <div class="ensemble-bar" id="bar-xgb"></div>
                          <div style="position: relative; z-index: 1; font-size: 9px;">XGBoost<br />(Speed)</div>
                        </div>
                        <div class="ensemble-model kan" style="height: 60px;">
                          <div class="ensemble-bar" id="bar-kan"></div>
                          <div style="position: relative; z-index: 1; font-size: 9px;">KAN<br />(Logic)</div>
                        </div>
                      </div>
                      <div class="ensemble-mixing" style="margin-top: 2px;">
                        <div class="mixing-line"></div>
                        <span style="font-size: 8px;">Unbiased Sampling</span>
                        <div class="mixing-line"></div>
                      </div>
                      <div
                        style="text-align: center; font-size: 9px; margin-top: 3px; color: var(--prob-purple); font-weight: 600;"
                        id="ensemble-result">
                        Calculating...
                      </div>
                    </div>
                  </div>
                </section>
              </div>
            </div>

            <script>
              (function () {
                const root = document.getElementById('routing-root');
                const svg = document.getElementById('routing-curves');
                if (!root || !svg) return;

                function drawRoutingCurves() {
                  svg.innerHTML = '';
                  const rootRect = root.getBoundingClientRect();
                  svg.setAttribute('width', rootRect.width);
                  svg.setAttribute('height', rootRect.height);
                  svg.setAttribute('viewBox', `0 0 ${rootRect.width} ${rootRect.height}`);

                  const features = Array.from(root.querySelectorAll('[data-feature]'));
                  const routes = Array.from(root.querySelectorAll('[data-route]'));
                  const routerCard = root.querySelector('.te-block-card');

                  if (!routerCard) return;

                  const routerRect = routerCard.getBoundingClientRect();
                  const routerX = routerRect.left + routerRect.width / 2 - rootRect.left;
                  const routerY = routerRect.top + routerRect.height / 2 - rootRect.top;

                  // Features -> Router
                  features.forEach(f => {
                    const fRect = f.getBoundingClientRect();
                    const fX = fRect.right - rootRect.left;
                    const fY = fRect.top + fRect.height / 2 - rootRect.top;

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.classList.add('te-curve-path');
                    const d = `M ${fX} ${fY} C ${fX + 40} ${fY}, ${routerX - 40} ${routerY}, ${routerX} ${routerY}`;
                    path.setAttribute('d', d);
                    f.dataset.curveId = 'f-' + f.dataset.feature; // Store ID for animation
                    path.id = 'curve-f-' + f.dataset.feature;
                    svg.appendChild(path);
                  });

                  // Router -> Routes
                  routes.forEach(r => {
                    const rRect = r.getBoundingClientRect();
                    const rX = rRect.left - rootRect.left;
                    const rY = rRect.top + rRect.height / 2 - rootRect.top;

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.classList.add('te-curve-path');
                    const d = `M ${routerX} ${routerY} C ${routerX + 40} ${routerY}, ${rX - 40} ${rY}, ${rX} ${rY}`;
                    path.setAttribute('d', d);

                    if (r.dataset.route === '0') {
                      path.style.stroke = 'var(--curve-color)';
                      path.style.strokeWidth = '8';
                      path.style.opacity = '1';
                    }
                    path.id = 'curve-r-' + r.dataset.route;
                    svg.appendChild(path);
                  });
                }

                window.addEventListener('load', drawRoutingCurves);
                setTimeout(drawRoutingCurves, 100);
              })();
            </script>
          </section>
        </main>
      </div>

      <div class="page" id="page-3">
        <main class="te-page" style="margin:0;padding:0">
          <section class="te-shell">
            <header>
              <div class="te-kicker">AI AGENT EXECUTION FLOW VISUALLY EXPLAINED</div>
              <h1 class="te-title">Agent Execution · Orchestrated</h1>
              <p class="te-subtitle">
                Multiple agents collaborate sequentially to analyze, plan, edit, and validate changes.
              </p>
            </header>

            <!-- Execution Timeline -->
            <div
              style="background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-size: 11px; font-weight: 600; color: #64748b;">Execution Timeline</div>
              </div>
              <div style="display: flex; gap: 4px; height: 24px;">
                <div
                  style="flex: 3; background: #06b6d4; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 9px; color: white; font-weight: 600;">
                  Analyzer 2.1s</div>
                <div
                  style="flex: 2; background: #8b5cf6; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 9px; color: white; font-weight: 600;">
                  Planner 1.8s</div>
                <div
                  style="flex: 4; background: #f59e0b; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 9px; color: white; font-weight: 600;">
                  Editor 4.1s</div>
                <div
                  style="flex: 1; background: #10b981; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 9px; color: white; font-weight: 600;">
                  Val 1.2s</div>
              </div>
            </div>

            <div class="te-diagram-wrapper" id="exec-root">
              <svg class="te-curve-layer" id="exec-curves"></svg>

              <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; margin-top:16px">
                <!-- Analyzer -->
                <div class="te-card te-embed-card" data-agent="0">
                  <div style="position:relative">
                    <div style="font-size:14px; font-weight:600; margin-bottom:6px; color:var(--color-analyzer)">Analyzer
                    </div>
                    <div style="font-size:10px; color:var(--text-muted); margin-bottom:8px">
                      <div>• Scan codebase</div>
                      <div>• Identify patterns</div>
                      <div>• Extract context</div>
                    </div>
                  </div>
                </div>

                <!-- Planner -->
                <div class="te-card te-embed-card" data-agent="1">
                  <div style="position:relative">
                    <div style="font-size:14px; font-weight:600; margin-bottom:6px; color:var(--color-planner)">Planner
                    </div>
                    <div style="font-size:10px; color:var(--text-muted); margin-bottom:8px">
                      <div>• Design approach</div>
                      <div>• Define steps</div>
                      <div>• Set constraints</div>
                    </div>
                  </div>
                </div>

                <!-- Editor -->
                <div class="te-card te-embed-card" data-agent="2">
                  <div style="position:relative">
                    <div style="font-size:14px; font-weight:600; margin-bottom:6px; color:var(--color-editor)">Editor</div>
                    <div style="font-size:10px; color:var(--text-muted); margin-bottom:8px">
                      <div>• Apply changes</div>
                      <div>• Generate code</div>
                      <div>• Refactor files</div>
                    </div>
                  </div>
                </div>

                <!-- Validator -->
                <div class="te-card te-embed-card" data-agent="3">
                  <div style="position:relative">
                    <div style="font-size:14px; font-weight:600; margin-bottom:6px; color:var(--color-validator)">
                      Validator</div>
                    <div style="font-size:10px; color:var(--text-muted); margin-bottom:8px">
                      <div>• Run tests</div>
                      <div>• Check lints</div>
                      <div>• Verify syntax</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Agent Workflow Explanation -->
            <div style="margin-top: 16px; background: #f8fafc; border-radius: 8px; padding: 12px;">
              <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: #475569;">How Agents Collaborate
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                <div>
                  <div style="font-size: 10px; font-weight: 600; color: #06b6d4; margin-bottom: 4px;">Analyzer Role
                  </div>
                  <div style="font-size: 9px; color: #64748b; line-height: 1.4;">
                    Scans the entire codebase using AST parsing to build a dependency graph. Identifies relevant files,
                    extracts context, and provides structural insights for subsequent agents.
                  </div>
                </div>
                <div>
                  <div style="font-size: 10px; font-weight: 600; color: #8b5cf6; margin-bottom: 4px;">Planner Role</div>
                  <div style="font-size: 9px; color: #64748b; line-height: 1.4;">
                    Takes high-level goals and breaks them into executable steps. Uses context from Analyzer to create
                    structured implementation plans with constraints and dependencies.
                  </div>
                </div>
                <div>
                  <div style="font-size: 10px; font-weight: 600; color: #f59e0b; margin-bottom: 4px;">Editor Role</div>
                  <div style="font-size: 9px; color: #64748b; line-height: 1.4;">
                    Executes the plan by generating code snippets, applying changes to files, and refactoring existing
                    code.
                    Includes auto-recovery for tool failures.
                  </div>
                </div>
                <div>
                  <div style="font-size: 10px; font-weight: 600; color: #10b981; margin-bottom: 4px;">Validator Role
                  </div>
                  <div style="font-size: 9px; color: #64748b; line-height: 1.4;">
                    Ensures correctness by running automated tests, linters, and syntax checks. Validates that changes
                    meet
                    quality standards before completion.
                  </div>
                </div>
              </div>
            </div>

            <script>
              (function () {
                const root = document.getElementById('exec-root');
                const svg = document.getElementById('exec-curves');
                if (!root || !svg) return;

                function drawExecCurves() {
                  svg.innerHTML = '';
                  const rootRect = root.getBoundingClientRect();
                  svg.setAttribute('width', rootRect.width);
                  svg.setAttribute('height', rootRect.height);
                  svg.setAttribute('viewBox', `0 0 ${rootRect.width} ${rootRect.height}`);

                  const agents = Array.from(root.querySelectorAll('[data-agent]'));

                  for (let i = 0; i < agents.length - 1; i++) {
                    const a1 = agents[i].getBoundingClientRect();
                    const a2 = agents[i + 1].getBoundingClientRect();

                    const x1 = a1.right - rootRect.left;
                    const y1 = a1.top + a1.height / 2 - rootRect.top;
                    const x2 = a2.left - rootRect.left;
                    const y2 = a2.top + a2.height / 2 - rootRect.top;

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.classList.add('te-curve-path');
                    const d = `M ${x1} ${y1} C ${x1 + 30} ${y1}, ${x2 - 30} ${y2}, ${x2} ${y2}`;
                    path.setAttribute('d', d);
                    path.id = 'exec-curve-' + i;
                    svg.appendChild(path);
                  }
                }

                window.addEventListener('load', drawExecCurves);
                setTimeout(drawExecCurves, 100);
              })();
            </script>
          </section>
        </main>
      </div>

      <div class="page" id="page-4">
        <main class="te-page" style="margin:0;padding:0">
          <section class="te-shell">
            <header>
              <div class="te-kicker">AI AGENT EXECUTION FLOW VISUALLY EXPLAINED</div>
              <h1 class="te-title">Response Generation · Transformers</h1>
              <p class="te-subtitle">
                The final response is decoded from execution context using the transformer.
              </p>
            </header>

            <div class="te-diagram-wrapper" id="response-root">
              <svg class="te-curve-layer" id="response-curves"></svg>

              <div class="te-top-labels">
                <div class="te-top-left">
                  <span class="te-label-strong">RAG Context</span>
                  <span class="te-label-strong">Transformer Decoder</span>
                </div>
                <div class="te-top-right">
                  <span class="te-label-strong">Generated Response</span>
                </div>
              </div>

              <div class="te-diagram-grid" style="grid-template-columns: 200px minmax(0, 1fr) 200px;">
                <!-- Context -->
                <section class="te-col">
                  <div class="te-stage-caption">RAG Context</div>
                  <div class="te-card te-embed-card">
                    <div style="font-size: 10px; color: var(--color-text-tertiary); margin-bottom: var(--space-2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Retrieved Files</div>
                    <div style="font-size: 10px; color: var(--color-text-secondary); margin-bottom: var(--space-2); line-height: 1.5;">
                      <div style="margin-bottom: 4px;">→ auth/index.ts (342 lines)</div>
                      <div style="margin-bottom: 4px;">→ middleware/jwt.ts (89 lines)</div>
                      <div style="margin-bottom: 4px;">→ tests/auth.test.ts (156 lines)</div>
                    </div>
                    
                    <div style="font-size: 10px; color: var(--color-text-tertiary); margin: var(--space-3) 0 var(--space-2) 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; padding-top: var(--space-2); border-top: 1px solid var(--color-border);">Agent Results</div>
                    <div style="font-size: 10px; color: var(--color-text-secondary); line-height: 1.5;">
                      <div style="margin-bottom: 4px;">✓ Files modified: 3</div>
                      <div style="margin-bottom: 4px;">✓ Tests passed: 12/12</div>
                      <div style="margin-bottom: 4px;">✓ Lints clean</div>
                    </div>

                    <div style="margin-top: var(--space-3); padding: var(--space-2); background: var(--color-surface); border-radius: var(--radius-sm); font-size: 9px; color: var(--color-text-tertiary);">
                      Context: 4,102 tokens<br/>
                      Window: 128K tokens
                    </div>
                  </div>
                </section>

                <!-- Decoder -->
                <section class="te-col">
                  <div class="te-stage-caption">Transformer Decoder</div>
                  <div class="te-card te-block-card">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                      <!-- Left: Process -->
                      <div>
                        <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-tertiary); font-weight: 600; margin-bottom: var(--space-2);">1. Context Embedding</div>
                        <div style="font-size: 10px; color: var(--color-text-secondary); line-height: 1.5; margin-bottom: var(--space-3);">
                          RAG retrieves code and agent results as vector embeddings.
                        </div>

                        <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-tertiary); font-weight: 600; margin-bottom: var(--space-2);">2. Self-Attention</div>
                        <div style="font-size: 10px; color: var(--color-text-secondary); line-height: 1.5; margin-bottom: var(--space-3);">
                          Cross-attention captures relationships between code and results.
                        </div>

                        <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-tertiary); font-weight: 600; margin-bottom: var(--space-2);">3. Token Generation</div>
                        <div style="font-size: 10px; color: var(--color-text-secondary); line-height: 1.5;">
                          Softmax sampling with temperature control.
                        </div>
                      </div>

                      <!-- Right: Technical Details -->
                      <div>
                        <div style="background: var(--color-surface); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
                          <div style="font-size: 10px; font-weight: 600; color: var(--color-text-primary); margin-bottom: var(--space-2);">Model Configuration</div>
                          <div style="font-size: 9px; color: var(--color-text-secondary); line-height: 1.6;">
                            <div style="margin-bottom: 4px;"><strong>Model:</strong> llama-3.1-8b</div>
                            <div style="margin-bottom: 4px;"><strong>Params:</strong> 8B</div>
                            <div style="margin-bottom: 4px;"><strong>Context:</strong> 128K tokens</div>
                            <div style="margin-bottom: 4px;"><strong>Temp:</strong> 0.7</div>
                            <div style="margin-bottom: 4px;"><strong>Top-p:</strong> 0.9</div>
                          </div>
                        </div>

                        <div style="background: var(--color-surface); padding: var(--space-3); border-radius: var(--radius-md);">
                          <div style="font-size: 10px; font-weight: 600; color: var(--color-text-primary); margin-bottom: var(--space-2);">Performance Metrics</div>
                          <div style="font-size: 9px; color: var(--color-text-secondary); line-height: 1.6;">
                            <div style="margin-bottom: 4px;">Tokens/sec: <strong>142</strong></div>
                            <div style="margin-bottom: 4px;">Latency: <strong>48ms</strong></div>
                            <div style="margin-bottom: 4px;">Cost: <strong>$0.0012</strong></div>
                            <div style="margin-bottom: 4px;">Cache hit: <strong>73%</strong></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Response Tokens -->
                <section class="te-col">
                  <div class="te-prob-title">Generated Response</div>
                  <div class="te-card te-prob-card">
                    <div style="font-size: 10px; color: var(--color-text-secondary); margin-bottom: var(--space-3); line-height: 1.5;">
                      Token-by-token generation with softmax sampling
                    </div>

                    <div class="te-prob-row te-prob-row--main" data-out="0">
                      <div class="te-prob-label">Done!</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent">95%</div>
                      </div>
                    </div>
                    <div class="te-prob-row te-prob-row--main" data-out="1">
                      <div class="te-prob-label">I've</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent">92%</div>
                      </div>
                    </div>
                    <div class="te-prob-row te-prob-row--main" data-out="2">
                      <div class="te-prob-label">added</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent">88%</div>
                      </div>
                    </div>
                    <div class="te-prob-row te-prob-row--main" data-out="3">
                      <div class="te-prob-label">authentication</div>
                      <div class="te-prob-bar-wrap">
                        <div class="te-prob-bar">
                          <div class="te-prob-bar-inner"></div>
                        </div>
                        <div class="te-prob-percent">97%</div>
                      </div>
                    </div>

                    <div style="margin-top: var(--space-4); padding-top: var(--space-3); border-top: 1px solid var(--color-border);">
                      <div style="font-size: 10px; font-weight: 600; color: var(--color-text-primary); margin-bottom: var(--space-2);">Final Response</div>
                      <div id="final-response" style="font-size: 11px; color: var(--color-text-secondary); line-height: 1.6; font-family: var(--font-mono); background: var(--color-surface); padding: var(--space-2); border-radius: var(--radius-sm);">
                        "Done! Added authentication. All 12 tests passing."
                      </div>
                    </div>

                    <div style="margin-top: var(--space-3); font-size: 9px; color: var(--color-text-tertiary);">
                      28 tokens · 196ms
                    </div>
                  </div>
                </section>
              </div>
            </div>


            <script>
              (function () {
                const root = document.getElementById('response-root');
                const svg = document.getElementById('response-curves');
                if (!root || !svg) return;

                function drawResponseCurves() {
                  svg.innerHTML = '';
                  const rootRect = root.getBoundingClientRect();
                  svg.setAttribute('width', rootRect.width);
                  svg.setAttribute('height', rootRect.height);
                  svg.setAttribute('viewBox', `0 0 ${rootRect.width} ${rootRect.height}`);

                  const ctxRows = Array.from(root.querySelectorAll('[data-ctx]'));
                  const decoder = root.querySelector('.te-block-card');

                  if (!decoder) return;

                  const decRect = decoder.getBoundingClientRect();
                  const decX = decRect.left + decRect.width / 2 - rootRect.left;
                  const decY = decRect.top + decRect.height / 2 - rootRect.top;

                  ctxRows.forEach(ctx => {
                    const cRect = ctx.getBoundingClientRect();
                    const cX = cRect.right - rootRect.left;
                    const cY = cRect.top + cRect.height / 2 - rootRect.top;

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.classList.add('te-curve-path');
                    const d = `M ${cX} ${cY} C ${cX + 50} ${cY}, ${decX - 50} ${decY}, ${decX} ${decY}`;
                    path.setAttribute('d', d);
                    path.id = 'resp-curve-' + ctx.dataset.ctx;
                    svg.appendChild(path);
                  });
                }

                window.addEventListener('load', drawResponseCurves);
                setTimeout(drawResponseCurves, 100);
              })();
            </script>
          </section>
        </main>
      </div>

      <!-- Navigation Dots (Overlay) -->
      <div class="page-nav" id="page-nav">
        <div class="nav-dot active" onclick="goToPage(1)"></div>
        <div class="nav-dot" onclick="goToPage(2)"></div>
        <div class="nav-dot" onclick="goToPage(3)"></div>
        <div class="nav-dot" onclick="goToPage(4)"></div>
      </div>
    </div> <!-- End pages-panel -->
  </div> <!-- End demo-interface -->

  <!-- Status Bar -->
  <div class="viz-stats">
    <div class="stat-item">
      <span class="stat-label">Model</span>
      <span class="stat-value" id="stat-model">claude-3-5-sonnet</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Cost</span>
      <span class="stat-value" id="stat-cost">$0.000000</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Time</span>
      <span class="stat-value" id="stat-time">0.0s</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Status</span>
      <span class="status-badge" id="stat-status">IDLE</span>
    </div>
  </div>
</div> <!-- End explainer-container -->

<script>
  class Director {
    constructor() {
      this.terminal = document.getElementById('terminal');
      this.stats = {
        model: document.getElementById('stat-model'),
        cost: document.getElementById('stat-cost'),
        time: document.getElementById('stat-time'),
        status: document.getElementById('stat-status')
      };
      this.startTime = 0;
      this.cost = 0;
    }

    async start() {
      this.updateStatus('RUNNING', 'running');
      this.startTime = Date.now();
      this.startTimer();

      await this.stepInput();
      await this.wait(800);

      await this.stepTransformer();
      await this.wait(800);

      await this.stepRouting();
      await this.wait(800);

      await this.stepExecution();
      await this.wait(800);

      await this.stepResponse();

      this.stopTimer();
      this.updateStatus('COMPLETED', 'success');
    }

    startTimer() {
      this.timerInterval = setInterval(() => {
        if (this.stats.status.textContent === 'RUNNING') {
          const elapsed = (Date.now() - this.startTime) / 1000;
          this.stats.time.textContent = elapsed.toFixed(1) + 's';
        }
      }, 100);
    }

    stopTimer() {
      if (this.timerInterval) {
        clearInterval(this.timerInterval);
        this.timerInterval = null;
      }
    }

    updateCost(amount) {
      this.cost += amount;
      this.stats.cost.textContent = '$' + this.cost.toFixed(6);
    }

    updateStatus(text, className) {
      this.stats.status.textContent = text;
      this.stats.status.className = 'status-badge ' + className;
    }

    setModel(name) {
      this.stats.model.textContent = name;
    }

    async stepInput() {
      this.setModel('system/cli');
      await this.type('> chu do "add user authentication"', 'term-prompt term-cmd');
      await this.wait(500);
    }

    async stepTransformer() {
      this.goToPage(1);
      this.setModel('groq/llama-3.1-8b-instant');
      await this.type('ℹ [LLM] Tokenizing input prompt...', 'term-log');

      if (window.highlightToken) {
        for (let i = 0; i < 5; i++) {
          window.highlightToken(i);
          await this.wait(400);
        }
        window.clearHighlights();
      }
      await this.wait(500);
    }

    async stepRouting() {
      this.goToPage(2);
      this.setModel('groq/llama-3.1-8b-instant');
      await this.type('ℹ [Router] Analyzing request complexity...', 'term-log');

      // Granular animation: Cycle features
      const features = document.querySelectorAll('#routing-root .te-prob-row');
      for (let i = 0; i < features.length; i++) {
        features[i].classList.add('is-highlighted');
        const curve = document.getElementById('curve-f-' + i);
        if (curve) { curve.style.stroke = 'var(--prob-purple)'; curve.style.opacity = '1'; }
        await this.wait(300);
        features[i].classList.remove('is-highlighted');
        if (curve) { curve.style.stroke = ''; curve.style.opacity = ''; }
      }

      await this.wait(200);

      // Show Routing Extra (Model Card + Complexity + Ensemble)
      const extra = document.getElementById('routing-extra');
      if (extra) extra.classList.add('visible');

      await this.type('ℹ [ModelRecommender] Selecting optimal profile...', 'term-log');

      // Animate Complexity Meter
      const meter = document.getElementById('complexity-fill');
      if (meter) meter.style.width = '75%';

      await this.wait(400);

      // Animate Ensemble
      const ensViz = document.getElementById('ensemble-viz');
      if (ensViz) {
        ensViz.classList.add('visible');
        await this.wait(200);

        // Fill bars
        document.getElementById('bar-xgb').style.height = '40%'; // Speed
        await this.wait(200);
        document.getElementById('bar-kan').style.height = '90%'; // Logic

        await this.wait(400);
        document.getElementById('ensemble-result').textContent = '✓ Weight: 0.8 KAN / 0.2 XGB';
      }

      this.updateCost(0.000008); // Router cost

      await this.wait(600);
      await this.type('✓ [Router] Mode: OrchestratedMode (Confidence: 0.92)', 'term-log success');

      // Highlight selected route
      const route = document.querySelector('#routing-root [data-route="0"]');
      if (route) route.classList.add('is-highlighted');
      const rCurve = document.getElementById('curve-r-0');
      if (rCurve) { rCurve.style.stroke = 'var(--prob-purple)'; rCurve.style.opacity = '1'; }

      await this.wait(1000);
    }

    async stepExecution() {
      this.goToPage(3);
      await this.type('ℹ [Orchestrator] Initializing agent workflow...', 'term-log');
      await this.type('  → Strategy: Optimized for Intelligence (KAN)', 'term-log');

      const agents = document.querySelectorAll('#exec-root .te-card');

      // Analyzer (Research)
      this.setModel('groq/compound');
      await this.type('ℹ [Analyzer] Scanning src/ directory...', 'term-log');
      this.highlightAgent(agents[0], true);

      // Show Analyzer Details
      const anDetails = document.getElementById('analyzer-details');
      if (anDetails) {
        anDetails.classList.add('visible');
        const items = anDetails.querySelectorAll('.detail-item');
        for (const item of items) {
          item.classList.add('visible');
          await this.wait(150);
        }
      }

      await this.wait(400);
      await this.type('  → Building dependency graph...', 'term-log');
      await this.wait(300);
      await this.type('  → Computing PageRank...', 'term-log');
      await this.wait(300);
      this.updateCost(0.000042); // Research cost
      await this.type('  - Found 14 relevant files', 'term-log');
      this.highlightAgent(agents[0], false);
      this.highlightCurve(0, true);

      // Planner (Query)
      this.setModel('openai/gpt-oss-120b');
      await this.type('ℹ [Planner] Creating implementation plan...', 'term-log');
      this.highlightAgent(agents[1], true);

      // Show Planner Details
      const plDetails = document.getElementById('planner-details');
      if (plDetails) {
        plDetails.classList.add('visible');
        const items = plDetails.querySelectorAll('.detail-item');
        for (const item of items) {
          item.classList.add('visible');
          await this.wait(200);
        }
      }

      await this.wait(400);
      await this.type('  → Drafting steps...', 'term-log');
      await this.wait(300);
      await this.type('  → Defining success criteria...', 'term-log');
      await this.wait(300);
      this.updateCost(0.000156); // Query cost
      this.highlightAgent(agents[1], false);
      this.highlightCurve(1, true);

      // Editor (With Auto Recovery Simulation)
      this.setModel('moonshotai/kimi-k2-instruct');
      await this.type('ℹ [Editor] Applying edits...', 'term-log');
      this.highlightAgent(agents[2], true);

      // Simulate Failure
      await this.wait(500);
      await this.type('❌ [Editor] Error: tool "read_file" not available', 'term-log error');

      // Show Recovery Block
      const recBlock = document.getElementById('recovery-block');
      if (recBlock) {
        recBlock.classList.add('visible');
        await this.wait(800);
      }

      await this.type(' [Intelligence] Evaluating recovery options...', 'term-log');
      await this.wait(600);
      await this.type(' [Intelligence] Switching to openrouter/kimi:free (Score: 0.88)', 'term-log success');

      // Show Recovery Fix
      const recFix = document.getElementById('recovery-fix');
      if (recFix) {
        recFix.classList.add('visible');
        await this.wait(400);
      }

      // Retry with new model
      this.setModel('openrouter/kimi:free');
      await this.type(' [Editor] Retrying with new strategy...', 'term-log');

      // Show Editor Details (Success)
      const edDetails = document.getElementById('editor-details');
      if (edDetails) edDetails.classList.add('visible');

      await this.wait(400);
      await this.type('  → Validating file permissions...', 'term-log');
      await this.wait(300);
      await this.type('  → Applying patch to src/middleware/jwt.ts...', 'term-log');
      await this.wait(300);
      this.updateCost(0.000287); // Editor cost
      this.highlightAgent(agents[2], false);
      this.highlightCurve(2, true);

      // Validator
      this.setModel('system/test-runner');
      await this.type('ℹ [Validator] Verifying changes...', 'term-log');
      this.highlightAgent(agents[3], true);

      // Show Validator Details
      const valDetails = document.getElementById('validator-details');
      if (valDetails) {
        valDetails.classList.add('visible');
        const items = valDetails.querySelectorAll('.detail-item');
        for (const item of items) {
          item.classList.add('visible');
          await this.wait(200);
        }
      }

      await this.wait(400);
      await this.type('  → Running unit tests...', 'term-log');
      await this.wait(300);
      await this.type('  → Checking lints...', 'term-log');
      await this.wait(300);
      await this.type('  PASS src/tests/auth.test.ts (142ms)', 'term-log success');
      this.highlightAgent(agents[3], false);
      await this.wait(500);
    }

    highlightAgent(el, active) {
      if (!el) return;
      if (active) el.classList.add('is-highlighted');
      else el.classList.remove('is-highlighted');
    }

    highlightCurve(idx, active) {
      const c = document.getElementById('exec-curve-' + idx);
      if (c) {
        c.style.stroke = active ? 'var(--prob-purple)' : '';
        c.style.opacity = active ? '1' : '';
      }
    }

    async stepResponse() {
      this.goToPage(4);
      this.setModel('groq/llama-3.1-8b-instant');
      await this.type('ℹ [LLM] Decoding final response...', 'term-log');

      // Animate context curves one by one
      const ctxRows = document.querySelectorAll('#response-root [data-ctx]');
      for (let i = 0; i < ctxRows.length; i++) {
        ctxRows[i].classList.add('is-highlighted');
        const c = document.getElementById('resp-curve-' + i);
        if (c) { c.style.stroke = 'var(--prob-purple)'; c.style.opacity = '1'; }
        await this.wait(300);
        ctxRows[i].classList.remove('is-highlighted');
        if (c) { c.style.stroke = ''; c.style.opacity = ''; }
      }

      // Animate output tokens
      const tokens = document.querySelectorAll('#response-root .te-prob-row');
      for (const t of tokens) {
        t.classList.add('is-highlighted');
        await this.wait(200);
      }

      await this.wait(300);
      this.updateCost(0.000063); // Response generation cost
      
      // Display final message in terminal
      await this.type('✓ [System] Done! Added authentication. 3 files modified, 12 tests passing.', 'term-log success');
      await this.wait(500);
    }

    goToPage(n) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-dot').forEach((d, i) => {
        d.classList.toggle('active', i + 1 === n);
      });
      document.getElementById('page-' + n).classList.add('active');
    }

    async type(txt, cls = '') {
      const l = document.createElement('div');
      l.className = 'term-line ' + cls;
      this.terminal.appendChild(l);

      // Remove old lines to simulate scrolling "disappearing"
      while (this.terminal.children.length > 12) {
        this.terminal.removeChild(this.terminal.firstChild);
      }

      for (const c of txt) { l.textContent += c; await new Promise(r => setTimeout(r, 5)); }
      // Force scroll aggressively with multiple attempts to ensure it works
      const forceScroll = () => { this.terminal.scrollTop = this.terminal.scrollHeight; };
      requestAnimationFrame(forceScroll);
      setTimeout(forceScroll, 10);
      setTimeout(forceScroll, 50);
    }

    wait(ms) { return new Promise(r => setTimeout(r, ms)); }
  }

  function goToPage(n) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-dot').forEach((d, i) => d.classList.toggle('active', i + 1 === n));
    document.getElementById('page-' + n).classList.add('active');
  }

  document.addEventListener('DOMContentLoaded', () => {
    new Director().start();
  });
</script>
