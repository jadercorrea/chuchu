package main

import (
	"fmt"
	"strings"
	"time"

	"github.com/spf13/cobra"

	"chuchu/internal/intelligence/knowledge"
)

var knowledgeCmd = &cobra.Command{
	Use:   "knowledge",
	Short: "Manage knowledge graph of codebase concepts",
}

var knowledgeBuildCmd = &cobra.Command{
	Use:   "build [path]",
	Short: "Extract concepts and build knowledge graph",
	RunE: func(cmd *cobra.Command, args []string) error {
		rootDir := "."
		if len(args) > 0 {
			rootDir = args[0]
		}

		fmt.Println("üîç Extracting concepts from codebase...")
		fmt.Println()

		start := time.Now()

		extractor := knowledge.NewExtractor(rootDir)
		concepts, err := extractor.Extract()
		if err != nil {
			return fmt.Errorf("failed to extract concepts: %w", err)
		}

		fmt.Printf("‚úÖ Extracted %d concepts in %v\n", len(concepts), time.Since(start))
		fmt.Println()

		fmt.Println("üîó Building knowledge graph...")
		start = time.Now()

		kg := knowledge.BuildGraph(concepts)

		fmt.Printf("‚úÖ Built graph with %d edges in %v\n", len(kg.CoOccurrence), time.Since(start))
		fmt.Println()

		path := knowledge.GetGraphPath()
		if err := kg.Save(path); err != nil {
			return fmt.Errorf("failed to save knowledge graph: %w", err)
		}

		fmt.Printf("üíæ Saved to: %s\n", path)
		fmt.Println()

		stats := kg.Stats()
		fmt.Println("üìä Statistics:")
		fmt.Printf("  Total concepts: %d\n", stats["total_concepts"])
		fmt.Printf("  Total edges: %d\n", stats["total_edges"])
		fmt.Printf("  Density: %.4f\n", stats["density"])
		fmt.Printf("  Files analyzed: %d\n", stats["total_docs"])
		fmt.Println()

		if byType, ok := stats["by_type"].(map[knowledge.ConceptType]int); ok {
			fmt.Println("  By type:")
			for cType, count := range byType {
				fmt.Printf("    %s: %d\n", cType, count)
			}
		}

		return nil
	},
}

var knowledgeStatsCmd = &cobra.Command{
	Use:   "stats",
	Short: "Show knowledge graph statistics",
	RunE: func(cmd *cobra.Command, args []string) error {
		path := knowledge.GetGraphPath()
		kg, err := knowledge.LoadGraph(path)
		if err != nil {
			return fmt.Errorf("failed to load knowledge graph: %w\nRun 'chu knowledge build' first", err)
		}

		stats := kg.Stats()

		fmt.Println("üìä Knowledge Graph Statistics")
		fmt.Println(strings.Repeat("=", 60))
		fmt.Println()

		fmt.Printf("Total concepts: %d\n", stats["total_concepts"])
		fmt.Printf("Total edges: %d\n", stats["total_edges"])
		fmt.Printf("Density: %.4f\n", stats["density"])
		fmt.Printf("Files analyzed: %d\n", stats["total_docs"])
		fmt.Println()

		if byType, ok := stats["by_type"].(map[knowledge.ConceptType]int); ok {
			fmt.Println("By type:")
			for cType, count := range byType {
				fmt.Printf("  %s: %d\n", cType, count)
			}
		}

		fmt.Println()
		fmt.Printf("Graph file: %s\n", path)

		return nil
	},
}

var knowledgeQueryCmd = &cobra.Command{
	Use:   "query <concept>",
	Short: "Find concepts related to a given concept",
	Args:  cobra.MinimumNArgs(1),
	RunE: func(cmd *cobra.Command, args []string) error {
		conceptName := args[0]

		path := knowledge.GetGraphPath()
		kg, err := knowledge.LoadGraph(path)
		if err != nil {
			return fmt.Errorf("failed to load knowledge graph: %w\nRun 'chu knowledge build' first", err)
		}

		conceptKey := ""
		for key, concept := range kg.Concepts {
			if strings.EqualFold(concept.Name, conceptName) {
				conceptKey = key
				break
			}
		}

		if conceptKey == "" {
			return fmt.Errorf("concept '%s' not found in knowledge graph", conceptName)
		}

		concept := kg.Concepts[conceptKey]
		related := kg.FindRelated(conceptKey, 10)

		fmt.Printf("üîç Concept: %s (%s)\n", concept.Name, concept.Type)
		fmt.Printf("   File: %s", concept.File)
		if concept.Line > 0 {
			fmt.Printf(":%d", concept.Line)
		}
		fmt.Println()
		fmt.Printf("   Occurrences: %d\n", concept.Count)
		if concept.Context != "" {
			fmt.Printf("   Context: %s\n", concept.Context)
		}
		fmt.Println()

		if len(related) == 0 {
			fmt.Println("No related concepts found.")
			return nil
		}

		fmt.Printf("üîó Related concepts (top %d):\n", len(related))
		fmt.Println(strings.Repeat("=", 60))

		for i, r := range related {
			fmt.Printf("\n%d. %s (%s) - Score: %.2f\n", i+1, r.Concept.Name, r.Concept.Type, r.Score)
			fmt.Printf("   File: %s", r.Concept.File)
			if r.Concept.Line > 0 {
				fmt.Printf(":%d", r.Concept.Line)
			}
			fmt.Println()
			if r.Concept.Context != "" && len(r.Concept.Context) < 100 {
				fmt.Printf("   Context: %s\n", r.Concept.Context)
			}
		}

		return nil
	},
}

var knowledgePathCmd = &cobra.Command{
	Use:   "path",
	Short: "Show path to knowledge graph file",
	Run: func(cmd *cobra.Command, args []string) {
		fmt.Println(knowledge.GetGraphPath())
	},
}

func init() {
	knowledgeCmd.AddCommand(knowledgeBuildCmd)
	knowledgeCmd.AddCommand(knowledgeStatsCmd)
	knowledgeCmd.AddCommand(knowledgeQueryCmd)
	knowledgeCmd.AddCommand(knowledgePathCmd)
	rootCmd.AddCommand(knowledgeCmd)
}
